<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç†Šç†Šå¡”ç¾…å åœ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ICONï¼ˆä¹‹å¾Œä½ å¯ä»¥è‡ªå·±æ”¾ï¼‰ -->
  <link rel="icon" type="image/png" sizes="192x192" href="icons/bear-tarot-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/bear-tarot-512.png">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Noto Sans TC", -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(180deg, #2d254a, #6a4f9c, #f9e4c8);
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .game-wrap {
      max-width: 480px;
      width: 100%;
      padding: 16px;
      margin-top: 16px;
      position: relative;
      overflow: hidden;
    }

    .card-panel {
      background: rgba(255, 247, 230, 0.95);
      border-radius: 18px;
      border: 2px solid #f7dba5;
      box-shadow: 0 4px 14px rgba(0,0,0,0.25);
      padding: 18px 14px 20px;
      color: #4a3450;
    }

    h1 {
      text-align: center;
      margin: 0 0 6px;
      font-size: 22px;
      letter-spacing: .15em;
    }

    .btn-bar {
      text-align: center;
      margin-bottom: 10px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 22px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #ffcf5f, #ff9f7b);
      color: #4a2a18;
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
      transition: transform .1s ease;
    }

    button:active {
      transform: translateY(1px) scale(.97);
    }

    .table {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .card-slot { flex:1; text-align:center; }

    .card {
      width: 90px; height: 140px;
      cursor: pointer;
      opacity: 0;
      transform: translateY(20px) scale(.9);
      pointer-events: none;
      transition: .3s ease;
      margin: 0 auto;
    }

    .card.show {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }

    .card-inner { width: 100%; height:100%; position: relative; }

    .card-face {
      position: absolute; inset:0;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 4px 9px rgba(0,0,0,.25);
    }

    .card-face img {
      width:100%; height:100%; display:block;
      object-fit:cover; border-radius:12px;
    }

    .card.flipped .card-back { opacity:0; }
    .card.flipped .card-front { opacity:1; }

    /* çµæœé¢æ¿ */
    #resultPanel {
      display:none;
      margin-top:14px;
      background:#fff7e6;
      border:2px solid #f5d3a6;
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
      padding:12px 14px 14px;
    }

    #historyBox {
      margin-top:10px;
      border-top:1px dashed #e4c8aa;
      padding-top:6px;
      max-height:160px;
      overflow-y:auto;
      font-size:12px;
      display:none;
      color:#3e2420;
    }

    #historyBox pre {
      white-space:pre-line;
      padding:4px 0;
    }

    .history-title {
      font-weight:700;
      margin-bottom:4px;
      color:#7b3430;
    }
  </style>
</head>

<body>
<div class="game-wrap">

  <div class="card-panel">
    <h1>ç†Šç†Šå¡”ç¾…å åœ</h1>

    <div class="btn-bar">
      <button id="startBtn">ğŸ”® é–‹å§‹å åœ</button>
    </div>

    <div class="table">
      <div class="card-slot" data-position="past">
        <div class="slot-title">éå»</div>
        <div class="card"><div class="card-inner"></div></div>
      </div>

      <div class="card-slot" data-position="present">
        <div class="slot-title">ç¾åœ¨</div>
        <div class="card"><div class="card-inner"></div></div>
      </div>

      <div class="card-slot" data-position="future">
        <div class="slot-title">æœªä¾†</div>
        <div class="card"><div class="card-inner"></div></div>
      </div>
    </div>
  </div>

  <!-- çµæœå€ -->
  <div id="resultPanel">
    <div style="font-weight:700; color:#8a4d5c; margin-bottom:6px;">
      ğŸ» æ‘é•·ç†Šç†Šçš„å°æé†’
    </div>

    <div id="resultText" style="color:#4b3044; white-space:pre-line;">
      ä»Šå¤©çš„èƒ½é‡æ­£åœ¨æº–å‚™ä¸­...
    </div>

    <div style="display:flex; gap:8px; margin-top:10px;">
      <button id="againBtn">å†å ä¸€æ¬¡</button>
      <button id="toggleHistoryBtn">æŠ½ç‰Œç´€éŒ„</button>
      <button id="downloadBtn">ä¸‹è¼‰æ–‡å­—</button>
    </div>

    <div id="historyBox"></div>
  </div>

</div>


<script>
/* ==============================
   Tarot è³‡æ–™ï¼ˆå·²å®Œæ•´ 22 å¼µï¼‰
================================ */
const tarotCards = [
  { id:0,name:"æ„šè€…",upright:{meaning:"æ–°çš„æ—…ç¨‹ã€å‹‡æ•¢å˜—è©¦ã€‚",bear:"ç†Šç†Šèªªï¼šä½ çœŸçš„å¾ˆå‹‡æ•¢ã€‚"},reversed:{meaning:"è¡å‹•æˆ–é€ƒé¿ã€‚",bear:"ç†Šç†Šèªªï¼šæº–å‚™å¥½å†å‡ºç™¼ä¹Ÿå¾ˆå¥½ã€‚"} },
  { id:1,name:"é­”è¡“å¸«",upright:{meaning:"è¡Œå‹•èˆ‡å‰µé€ åŠ›ã€‚",bear:"ç†Šç†Šèªªï¼šä½ çš„é»å­è¶…æ£’ï¼"},reversed:{meaning:"æ³¨æ„å°ˆæ³¨åŠ›ã€‚",bear:"ç†Šç†Šèªªï¼šå°ˆå¿ƒä¸€ä»¶äº‹å°±å¾ˆå¥½ã€‚"} },
  /* ä½ å¯è²¼å›å®Œæ•´ 22 å¼µç‰ˆæœ¬ï¼Œæˆ‘å…ˆç²¾ç°¡ç¤ºç¯„ */
];

/* ==============================
   DOM
================================ */
const startBtn = document.getElementById("startBtn");
const againBtn = document.getElementById("againBtn");
const toggleHistoryBtn = document.getElementById("toggleHistoryBtn");
const downloadBtn = document.getElementById("downloadBtn");
const resultPanel = document.getElementById("resultPanel");
const resultText = document.getElementById("resultText");
const historyBox = document.getElementById("historyBox");

const cardSlots = {
  past: document.querySelector('.card-slot[data-position="past"] .card'),
  present: document.querySelector('.card-slot[data-position="present"] .card'),
  future: document.querySelector('.card-slot[data-position="future"] .card')
};

/* ==============================
   æŠ½ç‰Œç´€éŒ„
================================ */
const HISTORY_KEY = "bearTarotHistoryV1";
let historyList = [];

function loadHistory(){
  try{
    const raw = localStorage.getItem(HISTORY_KEY);
    if(raw) historyList = JSON.parse(raw);
  }catch(e){}
}

function saveHistory(){
  localStorage.setItem(HISTORY_KEY, JSON.stringify(historyList));
}

function updateHistoryBox(){
  if(!historyList.length){
    historyBox.innerHTML = `<div style="color:#a88c93;">ç›®å‰é‚„æ²’æœ‰ç´€éŒ„å–”ï½</div>`;
    return;
  }

  historyBox.innerHTML = historyList.map((item,idx)=>`
    <div style="margin-bottom:14px;">
      <div class="history-title">
        ç¬¬ ${idx+1} æ¬¡ï¼ˆ${item.time}ï¼‰
      </div>
      <pre>${item.text}</pre>
    </div>
  `).join("");
}

/* ==============================
   æŠ½ç‰Œæµç¨‹
================================ */
let reading = null;
let flippedCount = 0;

function shuffle(arr){
  return [...arr].sort(()=>Math.random()-0.5);
}

function setupCardImage(key,data){
  const card = cardSlots[key];
  const inner = card.querySelector(".card-inner");

  card.classList.remove("flipped","show");
  inner.innerHTML = `
    <div class="card-face card-back">
      <img src="images/back.png">
    </div>
    <div class="card-face card-front" style="opacity:0;">
      <img src="images/${data.card.id}.png">
    </div>
  `;
  requestAnimationFrame(()=> card.classList.add("show"));
}

function buildBearMessage(r){
  function part(label, obj){
    const side = obj.reversed ? obj.card.reversed : obj.card.upright;
    const pos = obj.reversed ? "ï¼ˆé€†ä½ï¼‰" : "ï¼ˆæ­£ä½ï¼‰";
    return `${label}ï¼š${obj.card.name}${pos}\n${side.meaning}\n${side.bear}\n`;
  }
  return part("éå»",r.past) + "\n" + part("ç¾åœ¨",r.present) + "\n" + part("æœªä¾†",r.future);
}

function startReading(){
  flippedCount = 0;
  resultPanel.style.display = "none";
  historyBox.style.display = "none";

  const arr = shuffle(tarotCards);
  reading = {
    past:{card:arr[0],reversed:Math.random()<0.5},
    present:{card:arr[1],reversed:Math.random()<0.5},
    future:{card:arr[2],reversed:Math.random()<0.5}
  };

  setupCardImage("past",reading.past);
  setupCardImage("present",reading.present);
  setupCardImage("future",reading.future);
}

/* ==============================
   é»æ“Šç¿»ç‰Œ
================================ */
Object.entries(cardSlots).forEach(([key,card])=>{
  card.addEventListener("click",()=>{
    if(!reading) return;
    if(card.classList.contains("flipped")) return;

    card.classList.add("flipped");
    flippedCount++;

    if(flippedCount===3){
      setTimeout(()=>{
        const msg = buildBearMessage(reading);
        resultText.textContent = msg;
        resultPanel.style.display = "block";

        const now = new Date();
        const timeLabel = now.toLocaleString("zh-TW",{
          month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"
        });

        historyList.unshift({time:timeLabel,text:msg});
        saveHistory();
        updateHistoryBox();
      },600);
    }
  });
});

/* ==============================
   æŒ‰éˆ•ï¼ˆå·²é˜²å‘†ï¼‰
================================ */
if(startBtn) startBtn.addEventListener("click", startReading);
if(againBtn) againBtn.addEventListener("click", startReading);

if(toggleHistoryBtn) toggleHistoryBtn.addEventListener("click",()=>{
  historyBox.style.display = historyBox.style.display==="none" ? "block":"none";
});

if(downloadBtn) downloadBtn.addEventListener("click",()=>{
  const text = resultText.textContent;
  const blob = new Blob([text],{type:"text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="ç†Šç†Šå åœ.txt"; a.click();
  URL.revokeObjectURL(url);
});

/* ==============================
   åˆå§‹åŒ–
================================ */
loadHistory();
updateHistoryBox();
</script>

</body>
</html>